# Filename: Makefile
#
# Purpose:  Makefile for libreg
#
# Author:   Stephen Page

override cpu   := $(shell uname -m)
override os    := $(shell uname -s)

# Paths

exec_path       = $(os)/$(cpu)
dep_path        = $(os)/$(cpu)/dep
inc_path        = inc
lib             = $(exec_path)/libreg.a
obj_path        = $(os)/$(cpu)/obj
src_path        = src
doxygen_path    = html

vpath %.c $(src_path)
vpath %.h $(inc_path)

# Source and objects

source          = $(notdir $(wildcard $(src_path)/*.c))
objects         = $(source:%.c=$(obj_path)/%.o)

# Libraries

includes       += -I$(inc_path)

# Tools

AR             := $(shell which ar)
CC             := $(shell which gcc)

CFLAGS          = -O3 -g -Wall

# Targets

all: $(lib)

# libreg_pars.h and libreg_pars_init.h are both generated by pars.awk
# libreg_vars.h and libreg_vars_test.h are both generated by vars.awk

$(objects): inc/libreg_pars.h inc/libreg_vars.h

inc/libreg_pars.h: parameters/pars.csv parameters/pars.awk
	awk -f parameters/pars.awk parameters/pars.csv

inc/libreg_vars.h: variables/vars.csv variables/vars.awk
	awk -f variables/vars.awk variables/vars.csv

# Clean output files

clean:
	rm -f inc/libreg_pars.h inc/libreg_pars_init.h inc/libreg_vars.h inc/libreg_vars_test.h
	rm -rf $(doxygen_path) $(dep_path)/*.d $(obj_path)/*.o $(lib)

$(lib): $(objects)
	@[ -d $(@D) ] || mkdir -p $(@D)
	$(AR) -rs $@ $?

# Dependencies

include $(wildcard $(dep_path)/*.d)

# C objects

$(obj_path)/%.o: %.c
	@[ -d $(@D) ]       || mkdir -p $(@D)
	@[ -d $(dep_path) ] || mkdir -p $(dep_path)
	$(CC) $(CFLAGS) -MD -MF $(@:$(obj_path)/%.o=$(dep_path)/%.d) $(includes) -c -o $@ $<

# Special targets

doc:
	doxygen .doxygen

.PHONY: all clean doc

# EOF
